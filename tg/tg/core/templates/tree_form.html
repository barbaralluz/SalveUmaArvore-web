{% extends "control_panel.html" %}

{% load staticfiles %}

{% block title %}
    Formulário de Árvores
{% endblock %}

{% block content_logged %}

  <link href="{% static 'css/tree_form.css' %}" rel="stylesheet" />
 
    <div class="col-md-9">
      <div class="profile-content">

        <!-- Tab para busca de endereço -->
        <div class="tabbable-panel">
          
          <div class="tabbable-line">
            
            <ul class="nav nav-tabs ">
              <li class="active">
                <a href="#tab_default_1" data-toggle="tab"> Busque endereço com Google </a>
              </li>
              
              <li>
                <a href="#tab_default_2" data-toggle="tab"> Busque endereço com Nominatim </a>
              </li>
            </ul>
            
            <div class="tab-content">
              <!-- TAB GOOGLE -->
              <div class="tab-pane active" id="tab_default_1">
                <br/>
                <p>
                  <input id="address_google" type="text" class="form-control" placeholder="Informe Logradouro, Bairro, Cidade, Estado, País" />
                  <br/>
                  <button class="btn btn-success" type="submit" onclick="searchAddress_Google();">
                    <span class="glyphicon glyphicon-search"></span> 
                      Pesquisar
                  </button>

                  <button class="btn btn-danger"  onclick="limpa_textfield_id('address_google');">
                    <span class="glyphicon glyphicon-trash"></span> 
                    Limpar
                  </button>
                </p>
              </div>
              <!-- TAB NOMINATIM -->
              <div class="tab-pane" id="tab_default_2">
                <br/>
                <p>
                  <input id="address_nominatim" type="text" class="form-control" placeholder="Informe Logradouro, Bairro, Cidade, Estado, País" / >
                  <br/> 
                  <button class="btn btn-success" onclick="searchAddress_Nominatim();">
                    <span class="glyphicon glyphicon-search"></span> 
                    Pesquisar
                  </button>

                  <button class="btn btn-danger" onclick="limpa_textfield_id('address_nominatim');">
                    <span class="glyphicon glyphicon-trash"></span> 
                    Limpar
                  </button>

                  <div id="results"/> </div> 
                </p>
              </div>
            </div>
          </div>
        </div> <!-- Fim do tab de busca de endereço -->
        
        <p align="right" id="d">
          <button class="btn btn-primary btn-success" onclick='getLocation()'>
            <span class="glyphicon glyphicon-map-marker"></span> 
            Me localize!
          </button>
        </p>

        <form method="POST"  enctype="multipart/form-data">
        {% csrf_token %}
        
        {{ form.as_p }}

        <div id="dvPreview" align="center"></div> <!-- Para o preview da foto -->
        
        {% if form.instance.foto %}
          <style type="text/css">
            p > a {
              background-image: url({{ form.instance.foto.url }});
              background-position: center center;
              background-repeat:no-repeat;
              background-size: contain;
              display:list-item;
              height:190px;
              overflow:hidden;
              text-indent:100%;
              white-space:nowrap;
            }
          </style>
        {% endif %}
        
        <br/>
        
        <p align="center">

          {% if not form.instance.id %}

            <button type="submit" class="btn btn-success">
              <span class="glyphicon glyphicon-plus-sign"></span> 
                Cadastrar
          
          {% else %}

            <br>       
            
            <button type="submit" class="btn btn-warning">
                <span class="glyphicon glyphicon-pencil"></span> 
                Alterar
          {% endif %}
            </button>
            
            &nbsp;
            &nbsp;
            &nbsp;

            <button type="submit" onclick="{% url 'tree_list' %}" class="btn btn-danger" id="cancelar">
              <span class="glyphicon glyphicon-remove"></span> 
                Cancelar
            </button>
        </p> 
        </form>
        </div>
      </div> <!-- Final do Div md-9 -->
    </div>
  </div> <!-- Final do Container -->
        
  <style type="text/css">
    #id_geometry_map{
      width: 100%; height: 400px;
    }

    #id_geometry_div_map{
      width: 100%; height: 430px;
    }

    html, body {
      width:100%; height:100%; margin:0;
    }
          
    .olImageLoadError { display: none; }
  </style>
  
  <script src="{% static 'openlayers/OpenLayers.js' %}"></script> 
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>  

  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>  
  
  <script type="text/javascript">     

  //mantem opção do menu do usuário selecionado 
    $( document ).ready(function() {
    
      $("#tree").collapse('show');

      {% if not form.instance.id %}
        $("#add_tree").addClass('active');
      {% else %}
        $("#list_edit_exclude_tree").addClass('active');
      {% endif %}
    
    });   

  //função para limpar textfield de busca de endereço (Google e Nominatim)
  function limpa_textfield_id(nome_id){
    document.getElementById(nome_id).value = "";
    document.getElementById(nome_id).placeholder="Informe Logradouro, Bairro, Cidade, Estado, País";
  };
  //fim da função

  //função para add ícone ao clicar no mapa e altera posição do ícone ao clicar no mapa
  function mouse_mark(lonlat){
    markerslayer.clearMarkers();
    markerslayer.addMarker(new OpenLayers.Marker(lonlat,icon));

    lonlat.transform(
      new OpenLayers.Projection("EPSG:900913"), 
      new OpenLayers.Projection("EPSG:4326")
    );
    document.getElementById("id_geometry").value =  "POINT(" +  lonlat.lat + " " + lonlat.lon + ")";
  };
  //fim da função

  //função para add ícone
  function mark(lonlat){
    markerslayer.clearMarkers();
    markerslayer.addMarker(new OpenLayers.Marker(lonlat,icon));
    
    lonlat.transform(
      new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
      map.getProjectionObject() // to Spherical Mercator Projection
    );

    map.setCenter (lonlat, 18);
    document.getElementById("id_geometry").value =  "POINT(" +  lonlat.lat + " " + lonlat.lon + ")"
  };

  //função para encontrar localização do usuário (shared location - Google)
  function getLocation() {
    var geolocation_support = document.getElementById("d");
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(showPosition);
    } else { 
      geolocation_support.innerHTML = "Geolocation is not supported by this browser.";
    }
  };

  //função para marcar (add ícone) posição no mapa e chama função para buscar endereço com as coordenadas (getLocation - Google)
  function showPosition(position) {
    var lonlat = new OpenLayers.LonLat(position.coords.longitude, position.coords.latitude)
    mark(lonlat);
    document.getElementById("id_geometry").value =  "POINT(" +  position.coords.latitude + " " + position.coords.longitude + ")"
    search_LatLng_Address_Google(position.coords.latitude, position.coords.longitude);
  };
  //fim das funções

  //função busca dados do endereço de Lat, Long com o Google
  function search_LatLng_Address_Google(lat,lng) {
    document.getElementById('id_country').value = " ";
    document.getElementById('id_administrative_area_level_1').value = " ";
    document.getElementById('id_locality').value = " ";
    document.getElementById('id_neighborhood').value = " ";
    document.getElementById('id_route').value = " ";
    document.getElementById('id_postal_code').value = " ";  
            
    var lat = parseFloat(lat);
    var lng = parseFloat(lng);
    var latlng = new google.maps.LatLng(lat, lng);

    var geocoder = new google.maps.Geocoder();
        
    geocoder.geocode({'latLng': latlng}, function(results, status) {
    
      if (status == google.maps.GeocoderStatus.OK) {
        if (results[0]) {
          //console.log(results[0].formatted_address);
          components = results[0].address_components;
          for (var i = 0; i < components.length; i++) {
            short_name =  components[i].short_name ;
            type =  components[i].types[0];
            long_name =  components[i].long_name;
          
            if (document.getElementById("id_"+type)){
              document.getElementById("id_"+type).value = long_name;
            };
          };
        }
      } else {
        //alert("Geocoder failed: " + status);
        document.getElementById('id_country').value = " ";
        document.getElementById('id_administrative_area_level_1').value = " ";
        document.getElementById('id_locality').value = " ";
        document.getElementById('id_neighborhood').value = " ";
        document.getElementById('id_route').value = " ";
        document.getElementById('id_postal_code').value = " ";
      }
    });
  }; 
  //fim da função

  //função busca Lat, long de endereço com o Google
  function searchAddress_Google(){
    var address = document.getElementById("address_google").value;
    var geocoder = new google.maps.Geocoder();
    geocoder.geocode( { 'address': address}, function(results, status){
    
      if (status == google.maps.GeocoderStatus.OK){

        latLng = results[0].geometry.location;
        search_LatLng_Address_Google(latLng.lat(), latLng.lng());
            
        var lonlat = new OpenLayers.LonLat(latLng.lng(), latLng.lat())

        mark(lonlat);
        
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
  };
  //fim da função

  //busca de endereço com Nominatim
  function searchAddress_Nominatim() {
    var inp = document.getElementById("address_nominatim");

    $.getJSON('http://nominatim.openstreetmap.org/search?format=json&limit=5&q=' + inp.value, function (data) {
        var items = [];
        $.each(data, function (key, val) {
            var str = JSON.stringify([val.lat, val.lon]);
            items.push("<li><a href='#' onclick='mark_Nominatim(" + val.lat + "," + val.lon + ");'>" + val.display_name + '</a></li><br/>');

        });

        $('#results').empty();
        if (items.length !== 0) {
          $('<p>', {
              html: "Resultado:"
          }).appendTo('#results');
          
            $('<ul/>', {
              'class': 'my-new-list',
              html: items.join('')
            }).appendTo('#results');
        
        } else {
          $('<p>', {
            html:  "Resultado não encontrado"
          }).appendTo('#results');
        }
      });
  };

  function mark_Nominatim(lat,lon) {
    search_LatLng_Address_Nominatim(lat, lon);
    var zoom = 18;
    var lonlat = new OpenLayers.LonLat(lon, lat).transform(
      new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
      map.getProjectionObject() // to Spherical Mercator Projection
    );

    markerslayer.clearMarkers();
    markerslayer.addMarker(new OpenLayers.Marker(lonlat,icon));
    map.setCenter (lonlat, zoom);

    id_geometry.value = 'POINT('+ lonlat.lat +' ' + lonlat.lon +')';
  };

  //função para receber informação de endereço nominatim no formulário
  function cb(json) {    
    document.getElementById('id_country').value = json.address.country;
    document.getElementById('id_administrative_area_level_1').value = json.address.state;
    document.getElementById('id_locality').value = json.address.city;
    document.getElementById('id_neighborhood').value = json.address.suburb;
    document.getElementById('id_route').value = json.address.road;
    document.getElementById('id_postal_code').value = json.address.postcode;
  };

  //função para busca de dados de endereço com Lat e long - Nominatim
  function search_LatLng_Address_Nominatim(lat, lon) {
    var s = document.createElement('script');       
    s.src = 'http://nominatim.openstreetmap.org/reverse?json_callback=cb&format=json&lat='+lat+'&lon='+lon+'&zoom=27&addressdetails=1';
    document.getElementsByTagName('head')[0].appendChild(s);
  };
  //fim das funções de busca do Nominatim

  //Define o tipo de click dentro do mapa - single click 
  OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
    defaultHandlerOptions: {
      'single': true,
      'double': false,
      'pixelTolerance': 0,
      'stopSingle': false,
      'stopDouble': false
    },

    initialize: function(options) {
      this.handlerOptions = OpenLayers.Util.extend({}, this.defaultHandlerOptions);
      OpenLayers.Control.prototype.initialize.apply(this, arguments); 
      this.handler = new OpenLayers.Handler.Click(this, 
        {'click': this.trigger}, this.handlerOptions);
      }, 
           
      trigger: function(e) {
        
        var lonlat = map.getLonLatFromPixel(e.xy);
        mouse_mark(lonlat);
        search_LatLng_Address_Google(lonlat.lat, lonlat.lon);
                       
      } // fim da função trigger
      
    }); // fim da função click no mapa

    var map = new OpenLayers.Map('id_geometry_map');
    
    map.addLayer(new OpenLayers.Layer.OSM());
    map.zoomToMaxExtent();
                
    var markers = new OpenLayers.Layer.Markers( "Markers" );
    markers.id = "Markers";
    map.addLayer(markers);

    var size = new OpenLayers.Size(40,42);
    var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
    var icon = new OpenLayers.Icon('/static/img/marker.png', size, offset);   
    var markerslayer = map.getLayer('Markers');
    
    var click = new OpenLayers.Control.Click();
      
    map.addControl(click);
    click.activate();

    //se árvore já cadastrada aparece icone em local já cadastrado
    {% if form.instance.id%}
        
      var lat1 = String([{{ form.instance.geometry.x }}]);
      var lat = lat1.replace(",", ".")

      var lon1 = String([{{ form.instance.geometry.y }}]);
      var lon = lon1.replace(",", ".")

      var lonlat = new OpenLayers.LonLat( lon, lat )
        
      mark(lonlat);
    
    {%endif%}
    //fim da função      

    jQuery(document).ready(function(){
      jQuery('#id_country').width(100);
      jQuery('#id_country').attr("readonly", true);
      jQuery('#id_administrative_area_level_1').width(100);
      jQuery('#id_administrative_area_level_1').attr("readonly", true);
      jQuery('#id_locality').attr("readonly",true);
      jQuery('#id_neighborhood').attr("readonly",true);
      jQuery('#id_route').attr("readonly",true);
      jQuery('#id_postal_code').attr("readonly",true);
      jQuery('.input ul').attr("class","inputs-list");

      //jQuery('.clear_features').hide();
    });
 
  //função para Preview de Foto
    $(function () {
      $("#id_foto").change(function () {
        if (typeof (FileReader) != "undefined") {
          var dvPreview = $("#dvPreview");
          dvPreview.html("");
          var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.jpg|.jpeg|.gif|.png|.bmp)$/;
          $($(this)[0].files).each(function () {
            var file = $(this);
            if (regex.test(file[0].name.toLowerCase())) {
              var reader = new FileReader();
              reader.onload = function (e) {
                var img = $("<img />");
                img.attr("style", "height:25%;width: 25%");
                img.attr("class", "img-thumbnail");
                img.attr("src", e.target.result);
                dvPreview.append(img);
              }
              reader.readAsDataURL(file[0]);
            } else {
              alert(file[0].name + " is not a valid image file.");
              dvPreview.html("");
              return false;
            }
          });
        } else {
          alert("This browser does not support HTML5 FileReader.");
        }
      });
    });

  </script>

{% endblock content_logged %}

